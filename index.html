<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <title>Kamera -> Telegram (secure)</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      font-family: Arial, sans-serif;
    }
    #controls { margin-top: 12px; display:flex; gap:8px; align-items:center; }
    button { padding:8px 12px; border-radius:6px; border: none; cursor:pointer; }
    #status { margin-top:10px; opacity:0.9; font-size:14px; }
    video { width:320px; height:240px; background:#222; border-radius:8px; }
    input[type="number"] { width:72px; padding:6px; border-radius:6px; }
    canvas { display:none; }
  </style>
</head>
<body>
  <h1 id="hello">Kamera → Telegram</h1>

  <!-- video preview -->
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>

  <div id="controls">
    <button id="startBtn">Start kamera</button>
    <button id="stopBtn" disabled>Stop</button>
    <label>
      Interval (s):
      <input id="intervalInput" type="number" min="1" value="5" />
    </label>
    <button id="snapBtn">Bir martalik snap</button>
  </div>

  <div id="status">Holat: tayyor</div>

  <script>
    // --- MUHIM: client brauzerga BOT_TOKEN yuklamaydi.
    // Brauzer rasmni serverga yuboradi: /api/send-photo (server misol pastda).
    const UPLOAD_ENDPOINT = '/api/send-photo'; // kerak bo'lsa to'liq URL: https://yourdomain.com/api/send-photo
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const statusEl = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const snapBtn = document.getElementById('snapBtn');
    const intervalInput = document.getElementById('intervalInput');

    let stream = null;
    let intervalId = null;

    function setStatus(text, isError = false) {
      statusEl.textContent = `Holat: ${text}`;
      statusEl.style.color = isError ? '#ff6666' : '#fff';
    }

    async function startCamera() {
      try {
        // Browser must be HTTPS or localhost for camera
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = stream;
        setStatus('Kamera ishga tushdi — ruxsat berildi');
        startBtn.disabled = true;
        stopBtn.disabled = false;
        const intervalSec = Math.max(1, Number(intervalInput.value) || 5);
        startPeriodicCapture(intervalSec * 1000);
      } catch (err) {
        console.error('camera error', err);
        if (err.name === 'NotAllowedError') {
          setStatus('Foydalanuvchi ruxsat bermadi (NotAllowedError)', true);
        } else if (err.name === 'NotFoundError') {
          setStatus('Kamera topilmadi (NotFoundError)', true);
        } else {
          setStatus('Xatolik: ' + err.message, true);
        }
      }
    }

    function stopCamera() {
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;
      setStatus('Kamera to‘xtatildi');
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }

    function startPeriodicCapture(ms) {
      if (intervalId) clearInterval(intervalId);
      intervalId = setInterval(() => captureAndUpload(), ms);
      setStatus(`Har ${ms/1000} s da rasm yuboriladi`);
    }

    async function captureAndUpload() {
      if (!stream || !video.videoWidth) {
        console.warn('Video tayyor emas');
        return;
      }
      try {
        const w = video.videoWidth;
        const h = video.videoHeight;
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, w, h);

        // siqilgan jpeg data URL
        const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.8));
        if (!blob) throw new Error('Blob olinmadi');

        setStatus('Yuklanmoqda...');
        // Yuborish serverga (server Telegramga yuboradi)
        const form = new FormData();
        form.append('photo', blob, 'photo.jpg');
        // Optional: qo'shimcha ma'lumot jo'natish (masalan, chat_id override)
        // form.append('chat_id', '1889969457');

        const resp = await fetch(UPLOAD_ENDPOINT, { method: 'POST', body: form });
        if (!resp.ok) {
          const text = await resp.text().catch(()=>resp.statusText);
          throw new Error(`Server xatosi: ${resp.status} ${text}`);
        }
        const json = await resp.json().catch(()=>null);
        setStatus('Rasm yuborildi: ' + new Date().toLocaleTimeString());
        console.log('Server javobi:', json);
      } catch (err) {
        console.error('upload error', err);
        setStatus('Yuborishda xatolik: ' + err.message, true);
      }
    }

    // Bir martalik snap
    snapBtn.addEventListener('click', () => captureAndUpload());

    startBtn.addEventListener('click', () => startCamera());
    stopBtn.addEventListener('click', () => stopCamera());
    intervalInput.addEventListener('change', () => {
      const s = Math.max(1, Number(intervalInput.value) || 5);
      if (stream) startPeriodicCapture(s * 1000);
    });

    // Agar siz localhost da sinov qilsangiz, sahifa yuklanganda start qilish mumkin:
    // window.addEventListener('load', startCamera);
  </script>
</body>
</html>
